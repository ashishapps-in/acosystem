<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connect the Lines ¬∑ Ultimate P2P</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <style>
        /* ========================================= */
        /* üé® THEME VARIABLES & SYSTEM              */
        /* ========================================= */

        :root {
            /* Default: NEON Theme */
            --bg: #050510;
            --card: #121225;
            --card-border: #2a2a4a;
            --text: #e0e6ed;
            --subtext: #8b9bb4;
            
            --accent: #d946ef; /* Pink */
            --accent-glow: 0 0 10px rgba(217, 70, 239, 0.4);
            
            --p1: #00ff9d; /* Neon Green */
            --p1-glow: 0 0 12px rgba(0, 255, 157, 0.6);
            --p2: #00d9ff; /* Cyan */
            --p2-glow: 0 0 12px rgba(0, 217, 255, 0.6);
            
            --line-empty: #2d2d45;
            --line-hover: #ffffff;
            --dot: #565676;
            
            --btn-bg: #2d2d45;
            --btn-hover: #3d3d5c;
            
            --font-main: system-ui, -apple-system, sans-serif;
            --radius: 12px;
            
            /* Splash Text Color */
            --splash-color: #ffff55; 
            --splash-shadow: 2px 2px 0px #3f3f3f;
        }

        /* PASTEL THEME */
        body.theme-pastel {
            --bg: #fdf2f8;
            --card: #ffffff;
            --card-border: #fbcfe8;
            --text: #504e63;
            --subtext: #9ca3af;
            --accent: #f472b6;
            --accent-glow: none;
            --p1: #86efac;
            --p1-glow: none;
            --p2: #93c5fd;
            --p2-glow: none;
            --line-empty: #e5e7eb;
            --line-hover: #fcd34d;
            --dot: #d1d5db;
            --btn-bg: #f3f4f6;
            --btn-hover: #e5e7eb;
            --radius: 20px;
            --splash-color: #f59e0b;
            --splash-shadow: none;
        }

        /* CYBERPUNK THEME */
        body.theme-cyberpunk {
            --bg: #000000;
            --card: #1a1a05;
            --card-border: #facc15;
            --text: #facc15;
            --subtext: #71717a;
            --accent: #ef4444;
            --accent-glow: 2px 2px 0px rgba(239, 68, 68, 1);
            --p1: #bef264;
            --p1-glow: 2px 2px 0px rgba(190, 242, 100, 1);
            --p2: #22d3ee;
            --p2-glow: 2px 2px 0px rgba(34, 211, 238, 1);
            --line-empty: #3f3f46;
            --line-hover: #ffffff;
            --dot: #52525b;
            --btn-bg: #27272a;
            --btn-hover: #3f3f46;
            --radius: 0px;
            --font-main: "Courier New", monospace;
            --splash-color: #ef4444;
            --splash-shadow: 2px 2px 0px #000;
        }

        /* RETRO THEME */
        body.theme-retro {
            --bg: #2d2d2d;
            --card: #c0c0c0;
            --card-border: #ffffff #808080 #808080 #ffffff;
            --text: #000000;
            --subtext: #404040;
            --accent: #000080;
            --accent-glow: none;
            --p1: #008000;
            --p1-glow: none;
            --p2: #000080;
            --p2-glow: none;
            --line-empty: #808080;
            --line-hover: #ff0000;
            --dot: #000000;
            --btn-bg: #c0c0c0;
            --btn-hover: #dfdfdf;
            --radius: 0px;
            --font-main: "Courier", monospace;
            --splash-color: #000080;
            --splash-shadow: none;
        }

        /* ========================================= */
        /* üõ†Ô∏è RESET & LAYOUT                         */
        /* ========================================= */

        * { box-sizing: border-box; margin: 0; padding: 0; transition: background 0.2s, color 0.2s, border-color 0.2s; }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }

        /* --- 3-COLUMN GRID --- */
        .main-container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 280px 1fr 280px; 
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 950px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .middle-panel { order: 1; }
            .left-panel { order: 2; }
            .right-panel { order: 3; }
        }

        /* ========================================= */
        /* üì¶ CARDS & PANELS                         */
        /* ========================================= */

        .card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
        }

        .title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        h1 { font-size: 20px; font-weight: 800; color: var(--text); margin: 0; }
        h2 { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: var(--subtext); margin-bottom: 8px; border-bottom: 1px solid var(--line-empty); padding-bottom: 5px; }
        
        .tag { font-size: 10px; background: var(--btn-bg); padding: 4px 8px; border-radius: 99px; color: var(--accent); border: 1px solid var(--card-border); }

        .help-btn {
            background: var(--btn-bg); color: var(--subtext);
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; border: 1px solid var(--line-empty);
        }
        .help-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* ========================================= */
        /* üéÆ CONTROLS                              */
        /* ========================================= */

        input, select {
            background: var(--bg);
            border: 1px solid var(--line-empty);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            font-family: inherit;
            outline: none;
            font-size: 13px;
        }
        input:focus, select:focus { border-color: var(--accent); }

        button {
            cursor: pointer;
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid var(--line-empty);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 13px;
        }
        button:hover:not(:disabled) { background: var(--btn-hover); border-color: var(--subtext); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        button.primary { background: var(--accent); color: #fff; border: none; box-shadow: var(--accent-glow); }
        button.primary:hover:not(:disabled) { opacity: 0.9; }
        
        button.danger { border-color: #ef4444; color: #ef4444; background: transparent; }
        button.danger:hover { background: #ef4444; color: white; }

        .control-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .control-group { margin-bottom: 20px; }

        /* ========================================= */
        /* üí¨ CHAT SYSTEM                           */
        /* ========================================= */

        .chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 300px;
        }

        .chat-box {
            flex-grow: 1;
            background: var(--bg);
            border: 1px solid var(--line-empty);
            border-radius: 8px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .chat-msg { padding: 4px 8px; border-radius: 4px; max-width: 90%; word-wrap: break-word; }
        .chat-msg.system { color: var(--subtext); font-style: italic; text-align: center; width: 100%; margin: 5px 0; }
        .chat-msg.me { align-self: flex-end; background: var(--btn-bg); color: var(--text); border: 1px solid var(--line-empty); }
        .chat-msg.opp { align-self: flex-start; background: var(--card); border: 1px solid var(--accent); color: var(--accent); }

        /* ========================================= */
        /* üìä SCOREBOARD & BOARD                    */
        /* ========================================= */

        .scoreboard-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--btn-bg);
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            position: relative;
        }

        .splash-text {
            font-size: 14px;
            font-weight: 800;
            color: var(--splash-color);
            text-shadow: var(--splash-shadow);
            cursor: pointer;
            text-align: center;
            animation: pulse-text 0.8s infinite alternate ease-in-out;
            max-width: 180px;
            flex: 1; margin: 0 10px;
        }
        @keyframes pulse-text { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        .player-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 99px;
            border: 1px solid transparent;
            font-size: 13px;
            flex-shrink: 0;
        }
        .player-badge input { background: transparent; border: none; width: 70px; padding: 0; color: inherit; font-weight: bold; }
        .player-badge.p1 { color: var(--p1); border-color: var(--p1); background: rgba(0, 255, 157, 0.1); }
        .player-badge.p2 { color: var(--p2); border-color: var(--p2); background: rgba(0, 217, 255, 0.1); }
        .player-badge.active { box-shadow: 0 0 0 2px var(--text); animation: pulse-border 1s infinite; }
        @keyframes pulse-border { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .board-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg);
            border-radius: var(--radius);
            padding: 20px;
            flex-grow: 1;
            min-height: 350px;
            position: relative;
        }

        .board { display: flex; flex-direction: column; }
        .board-row { display: flex; align-items: center; }

        .dot { width: 10px; height: 10px; background: var(--dot); border-radius: 50%; z-index: 2; }
        
        .line-h { width: 60px; height: 8px; margin: 0 2px; background: var(--line-empty); border-radius: 4px; cursor: pointer; position: relative; }
        .line-v { width: 8px; height: 60px; margin: 2px 0; background: var(--line-empty); border-radius: 4px; cursor: pointer; position: relative; }
        
        .line-h:hover, .line-v:hover { background: var(--line-hover); box-shadow: 0 0 8px var(--line-hover); }
        .line-h.taken.p1, .line-v.taken.p1 { background: var(--p1); box-shadow: var(--p1-glow); cursor: default; }
        .line-h.taken.p2, .line-v.taken.p2 { background: var(--p2); box-shadow: var(--p2-glow); cursor: default; }

        .box {
            width: 60px; height: 60px; margin: 2px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .box.p1 { background: rgba(0, 255, 157, 0.15); color: var(--p1); transform: scale(0.9); }
        .box.p2 { background: rgba(0, 217, 255, 0.15); color: var(--p2); transform: scale(0.9); }

        #timerDisplay { font-family: monospace; font-weight: bold; display: none; color: var(--accent); }

        /* ========================================= */
        /* üèÅ OVERLAY & HELP POPUP                  */
        /* ========================================= */

        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 999;
        }
        .overlay.active { opacity: 1; pointer-events: all; }

        .overlay-card {
            background: var(--card); border: 2px solid var(--accent); padding: 30px;
            text-align: center; border-radius: var(--radius); box-shadow: 0 0 50px rgba(0,0,0,0.5);
            max-width: 450px; width: 90%; transform: scale(0.9); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        .overlay.active .overlay-card { transform: scale(1); }
        .overlay-title { font-size: 32px; font-weight: 900; color: var(--text); margin-bottom: 10px; }
        .overlay-score { font-size: 18px; color: var(--subtext); margin-bottom: 25px; }

        .help-section { text-align: left; margin-bottom: 20px; border-bottom: 1px solid var(--line-empty); padding-bottom: 15px; }
        .help-section h3 { color: var(--accent); font-size: 16px; margin-bottom: 8px; }
        .help-section p { font-size: 13px; color: var(--text); line-height: 1.5; margin-bottom: 8px; }
        .help-section li { font-size: 13px; color: var(--subtext); margin-bottom: 4px; }
    </style>
</head>
<body class="theme-neon">

<div class="main-container">
    <!-- LEFT PANEL: LOBBY & SETTINGS -->
    <div class="card left-panel">
        <div class="title-row">
            <h1>Connect P2P</h1>
            <button class="help-btn" onclick="openHelp()">?</button>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span class="tag">Status</span>
            <span class="tag" id="statusTag">Disconnected</span>
        </div>

        <div class="control-group">
            <h2>1. Room Setup</h2>
            <div class="control-row">
                <input id="roomIdInput" type="text" placeholder="Enter Room ID (e.g. 123)" maxlength="5">
                <button onclick="generateCode()" title="Random Code">üé≤</button>
            </div>
            <div class="control-row">
                <button class="primary" id="hostBtn" style="flex:1">Host</button>
                <button class="primary" id="joinBtn" style="flex:1; background:var(--btn-bg); border:1px solid var(--accent);">Join</button>
            </div>
            <button class="danger" id="disconnectBtn" style="width:100%" disabled>Disconnect</button>
        </div>

        <div class="control-group">
            <h2>2. Game Settings</h2>
            <div class="control-row">
                <select id="boardSize" disabled>
                    <option value="3">3x3 (Fast)</option>
                    <option value="4" selected>4x4 (Classic)</option>
                    <option value="5">5x5 (Large)</option>
                    <option value="6">6x6 (Mega)</option>
                </select>
            </div>
            <div class="control-row">
                <select id="gameMode" disabled>
                    <option value="classic">Mode: Classic</option>
                    <option value="first5">Mode: First to 5</option>
                    <option value="timed">Mode: Timed (3m)</option>
                </select>
            </div>
            <button class="primary" id="startBtn" style="width:100%" disabled>Start Match</button>
        </div>
    </div>

    <!-- MIDDLE PANEL: GAME BOARD & SCOREBOARD -->
    <div class="card middle-panel">
        <div class="scoreboard-container">
            <!-- Left: ALWAYS "You" (visual), color adjusted by JS -->
            <div id="p1Badge" class="player-badge p1 active">
                <span>‚óè</span> 
                <input id="myNm" value="You" maxlength="8"> 
                <span id="s1" class="score-display">0</span>
            </div>

            <!-- CENTER DISPLAY (Splash / Timer) -->
            <div id="centerDisplay" style="flex: 1; display:flex; justify-content:center;">
                <div id="splashText" class="splash-text" onclick="cycleSplash()">Also try Minecraft!</div>
                <div id="timerDisplay">03:00</div>
            </div>

            <!-- Right: ALWAYS Opponent (visual) -->
            <div id="p2Badge" class="player-badge p2">
                <span id="s2" class="score-display">0</span> 
                <span id="oppNm">Opponent</span> 
                <span>‚óè</span>
            </div>
        </div>

        <div class="board-wrapper">
            <div id="board" class="board">
                <div style="color:var(--subtext); text-align:center;">
                    <p style="font-size:24px; margin-bottom:10px;">‚ö°</p>
                    <p>Connect and play!</p>
                </div>
            </div>
        </div>
        
        <div style="text-align:center; font-size:12px; color:var(--subtext); margin-top:5px;">
            <span id="gameInfo">Host controls settings.</span>
        </div>
    </div>

    <!-- RIGHT PANEL: CHAT -->
    <div class="card right-panel">
        <div class="title-row">
            <h1>Chat Room</h1>
            <span class="tag">Live</span>
        </div>
        
        <div class="chat-container">
            <div class="chat-box" id="chatDisplay">
                <div class="chat-msg system">Welcome! Connect to play.</div>
            </div>
            <div class="control-row">
                <input id="chatInput" type="text" placeholder="Say hello..." disabled>
                <button id="sendChatBtn" disabled>‚û§</button>
            </div>
        </div>
    </div>
</div>


<!-- GAME OVER OVERLAY -->
<div id="overlay" class="overlay">
    <div class="overlay-card">
        <div class="overlay-title" id="winnerTitle">P1 Wins!</div>
        <div class="overlay-score" id="finalScore">Score: 5 - 2</div>
        <button class="primary" onclick="closeOverlay()">Close</button>
    </div>
</div>

<!-- HELP POPUP -->
<div id="helpOverlay" class="overlay">
    <div class="overlay-card" style="text-align:left;">
        <h1 style="text-align:center; margin-bottom:20px; color:var(--accent);">How to Play</h1>
        
        <div class="help-section">
            <h3>üéØ Objective</h3>
            <p>Connect two adjacent dots with a line. If you complete a 1x1 box, you earn a point and get an <strong>extra turn</strong>.</p>
        </div>

        <div class="help-section">
            <h3>üïπÔ∏è Game Modes</h3>
            <ul>
                <li><strong>Classic:</strong> Play until the board is full. Player with the most boxes wins.</li>
                <li><strong>First to 5:</strong> A quick match! The first player to capture 5 boxes wins immediately.</li>
                <li><strong>Timed (3m):</strong> Most boxes when the timer hits 00:00 wins.</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üìè Board Sizes</h3>
            <ul>
                <li><strong>3x3:</strong> Very fast paced.</li>
                <li><strong>4x4:</strong> The standard experience.</li>
                <li><strong>6x6:</strong> For strategic masterminds.</li>
            </ul>
        </div>

        <div style="text-align:center;">
            <button class="primary" onclick="closeHelp()">Got it!</button>
        </div>
    </div>
</div>

<script>
    // --- SPLASH TEXT LOGIC ---
    const splashes = [
        "Also try Minecraft!", "Now with more lines!", "Ashish is magic!", "Don't Speak lie!", 
        "Creeper? Aww man!", "Hello World!", "No Complex Coding involved!", "90% Bug Free!", 
        "Best Game!", "HTML5 inside!", "Do a barrel roll!", "Powered by CSS!", 
        "Connect them all!", "Is this a square?", "Look behind you!", "10/10 - Rated by the developer",
        "Better than Chess!", "Click me!", "Speech die", "Keyboard friendly!", "I am out of Ideas Now!", 
        "Why i made game for Kids", "Covid days are really Good", "Lord is my Shepard", "Who was the Iron Man?", "Try Other Modes also",
        "Invite people to game", "Want to end Friendship, Let them have a match with you", "AI will dominate the world", "I am good at writing random things", 
        "Do you know? Friend ends with end", "Great quotes are written by me while i wrote these", "Yes i am out of ideas", "why do you read it", "donot read, play", "Focus",
    ];

    function cycleSplash() {
        const el = document.getElementById('splashText');
        let newSplash;
        do {
            newSplash = splashes[Math.floor(Math.random() * splashes.length)];
        } while (newSplash === el.innerText);
        
        el.style.animation = 'none';
        el.offsetHeight;
        el.style.animation = 'pulse-text 0.8s infinite alternate ease-in-out';
        el.innerText = newSplash;
    }
    cycleSplash();

    // --- GAME VARIABLES ---
    let peer, conn;
    let myId = null;
    let isHost = false;
    let gameActive = false;

    // Logical players (global)
    // Player 1 = host, Player 2 = joiner
    let mePlayer = 1;
    let oppPlayer = 2;

    let turn = 1; 
    let p1Name = "You", p2Name = "Opponent";
    let scores = {1: 0, 2: 0};
    let size = 4;
    let mode = 'classic';
    let lines = {}, boxes = [];
    let timeLeft = 180;
    let timerInterval = null;

    const els = {
        board: document.getElementById('board'),
        chat: document.getElementById('chatDisplay'),
        chatIn: document.getElementById('chatInput'),
        roomIn: document.getElementById('roomIdInput'),
        status: document.getElementById('statusTag'),
        s1: document.getElementById('s1'),
        s2: document.getElementById('s2'),
        p1B: document.getElementById('p1Badge'),
        p2B: document.getElementById('p2Badge'),
        timer: document.getElementById('timerDisplay'),
        splash: document.getElementById('splashText'),
        startBtn: document.getElementById('startBtn'),
        boardSize: document.getElementById('boardSize'),
        gameMode: document.getElementById('gameMode'),
        myNm: document.getElementById('myNm'),
        oppNm: document.getElementById('oppNm')
    };

    // Adjust perspective so each side sees "You" on left with correct color
    function configurePerspective() {
        mePlayer = isHost ? 1 : 2;
        oppPlayer = mePlayer === 1 ? 2 : 1;

        // For joiner, swap badge colors so "You" (left) shows as Player 2 color
        if (!isHost) {
            els.p1B.classList.remove('p1');
            els.p1B.classList.add('p2');

            els.p2B.classList.remove('p2');
            els.p2B.classList.add('p1');
        }

        updateScoreUI();
    }

    function initPeer(id) {
        peer = new Peer(id, { debug: 1 });
        peer.on('open', (id) => {
            myId = id;
            els.status.textContent = isHost ? ("Hosting: " + id) : "Connected";
            sysMsg(isHost ? "Room created. Waiting for opponent..." : "Connected to server.");
            updateUIState(true);
        });

        peer.on('connection', (c) => {
            if (conn) { c.close(); return; }
            conn = c;
            setupConn();
        });

        peer.on('error', err => sysMsg("Net Error: " + err.type));
    }

    function setupConn() {
        conn.on('open', () => {
            els.status.textContent = "Matched!";
            sysMsg("Opponent connected!");

            configurePerspective();

            conn.send({ type: 'name', name: els.myNm.value });

            if (isHost) {
                conn.send({ type: 'syncSettings', size: els.boardSize.value, mode: els.gameMode.value });
                els.startBtn.disabled = false;
            }

            els.chatIn.disabled = false;
            document.getElementById('sendChatBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = false;
        });

        conn.on('data', handleData);
        conn.on('close', resetGame);
    }

    function handleData(data) {
        switch (data.type) {
            case 'name':
                p2Name = data.name;
                els.oppNm.textContent = p2Name;
                break;

            case 'chat':
                addChat(p2Name, data.msg, 'opp');
                break;

            case 'start':
                startGame(data.size, data.mode);
                break;

            case 'move': {
                // Remote move is always by the opponent
                const remotePlayer = oppPlayer;
                processMove(data.lineId, remotePlayer);
                break;
            }

            case 'tick':
                updateTimerUI(data.time);
                break;

            case 'end':
                endGame(data.winner);
                break;

            case 'syncSettings':
                els.boardSize.value = data.size;
                els.gameMode.value = data.mode;
                break;
        }
    }

    // --- BUTTON HANDLERS ---

    document.getElementById('hostBtn').onclick = () => {
        let code = els.roomIn.value;
        if (!code) return alert("Enter a room code!");
        isHost = true;
        initPeer("dbp2p-" + code);
        document.getElementById('hostBtn').disabled = true;
        document.getElementById('joinBtn').disabled = true;
        els.boardSize.disabled = false;
        els.gameMode.disabled = false;
    };

    document.getElementById('joinBtn').onclick = () => {
        let code = els.roomIn.value;
        if (!code) return alert("Enter a room code!");
        isHost = false;
        initPeer();
        setTimeout(() => {
            conn = peer.connect("dbp2p-" + code);
            setupConn();
        }, 800);
        document.getElementById('hostBtn').disabled = true;
        document.getElementById('joinBtn').disabled = true;
    };

    document.getElementById('disconnectBtn').onclick = () => {
        if (conn) conn.close();
        if (peer) peer.destroy();
        resetGame();
    };

    els.startBtn.onclick = () => {
        if (!conn || !conn.open) return;
        let s = parseInt(els.boardSize.value);
        let m = els.gameMode.value;
        conn.send({ type: 'start', size: s, mode: m });
        startGame(s, m);
    };

    // --- GAME LOGIC ---

    function startGame(s, m) {
        size = s;
        mode = m;
        scores = { 1: 0, 2: 0 };
        turn = 1;    // Always start with Player 1 (host)
        lines = {};
        boxes = [];
        gameActive = true;

        p1Name = els.myNm.value;
        if (isHost && conn && conn.open) {
            conn.send({ type: 'name', name: p1Name });
        }

        renderBoard();
        updateScoreUI();

        clearInterval(timerInterval);

        if (mode === 'timed') {
            els.splash.style.display = 'none';
            els.timer.style.display = 'block';
        } else {
            els.splash.style.display = 'block';
            els.timer.style.display = 'none';
        }

        if (mode === 'timed' && isHost) {
            timeLeft = 180;
            timerInterval = setInterval(() => {
                timeLeft--;
                if (conn && conn.open) {
                    conn.send({ type: 'tick', time: timeLeft });
                }
                updateTimerUI(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishGameByScore();
                }
            }, 1000);
        }

        document.getElementById('gameInfo').textContent = "Match started!";
    }

    function renderBoard() {
        els.board.innerHTML = '';
        for (let r = 0; r < size; r++) {
            let rowDiv = document.createElement('div');
            rowDiv.className = 'board-row';
            for (let c = 0; c < size; c++) {
                let dot = document.createElement('div');
                dot.className = 'dot';
                rowDiv.appendChild(dot);
                if (c < size - 1) {
                    let id = `h-${r}-${c}`;
                    let line = createLine(id, 'line-h');
                    lines[id] = { el: line, owner: 0, r, c, type: 'h' };
                    rowDiv.appendChild(line);
                }
            }
            els.board.appendChild(rowDiv);

            if (r < size - 1) {
                let vRowDiv = document.createElement('div');
                vRowDiv.className = 'board-row';
                for (let c = 0; c < size; c++) {
                    let id = `v-${r}-${c}`;
                    let line = createLine(id, 'line-v');
                    lines[id] = { el: line, owner: 0, r, c, type: 'v' };
                    vRowDiv.appendChild(line);

                    if (c < size - 1) {
                        let box = document.createElement('div');
                        box.className = 'box';
                        boxes.push({
                            el: box,
                            owner: 0,
                            lines: [
                                `h-${r}-${c}`,
                                `h-${r + 1}-${c}`,
                                `v-${r}-${c}`,
                                `v-${r}-${c + 1}`
                            ]
                        });
                        vRowDiv.appendChild(box);
                    }
                }
                els.board.appendChild(vRowDiv);
            }
        }
    }

    function createLine(id, className) {
        let l = document.createElement('div');
        l.className = className;
        l.id = id;
        l.onclick = () => handleLineClick(id);
        return l;
    }

    function handleLineClick(id) {
        if (!gameActive) return;
        if (!lines[id] || lines[id].owner !== 0) return;

        // Only the player whose turn it is can play
        if (turn !== mePlayer) return;
        if (!conn || !conn.open) return;

        processMove(id, mePlayer);
        conn.send({ type: 'move', lineId: id });
    }

    function processMove(id, player) {
        let lineObj = lines[id];
        if (!lineObj || lineObj.owner !== 0) return;

        lineObj.owner = player;
        lineObj.el.classList.add('taken', player === 1 ? 'p1' : 'p2');

        let madeBox = false;
        boxes.forEach(b => {
            if (b.owner === 0 && b.lines.every(lid => lines[lid].owner !== 0)) {
                b.owner = player;
                b.el.classList.add(player === 1 ? 'p1' : 'p2');
                b.el.innerText = player === 1 ? "1" : "2";
                scores[player]++;
                madeBox = true;
            }
        });

        if (mode === 'first5' && scores[player] >= 5) {
            finishGameByScore();
            return;
        }

        if (!madeBox) {
            turn = (turn === 1) ? 2 : 1;
        }

        updateScoreUI();
        checkWin();
    }

    function checkWin() {
        let totalBoxes = (size - 1) * (size - 1);
        if (scores[1] + scores[2] >= totalBoxes) {
            finishGameByScore();
        }
    }

    function finishGameByScore() {
        if (!isHost) return; // only host decides outcome
        let winner = 0;
        if (scores[1] > scores[2]) winner = 1;
        else if (scores[2] > scores[1]) winner = 2;

        if (conn && conn.open) {
            conn.send({ type: 'end', winner: winner });
        }
        endGame(winner);
    }

    function endGame(winner) {
        gameActive = false;
        clearInterval(timerInterval);

        let title = "Draw Game!";
        if (winner === mePlayer) title = "You Win!";
        else if (winner === oppPlayer) title = "Opponent Wins!";

        document.getElementById('winnerTitle').innerText = title;
        document.getElementById('finalScore').innerText = 
            `Final Score: ${scores[mePlayer]} - ${scores[oppPlayer]}`;

        document.getElementById('overlay').classList.add('active');
        els.timer.style.display = 'none';
        els.splash.style.display = 'block';
    }

    function updateScoreUI() {
        // Show MY score on left, OPPONENT on right
        els.s1.textContent = scores[mePlayer];
        els.s2.textContent = scores[oppPlayer];

        // Highlight turn: if it's my turn, left badge active
        els.p1B.classList.toggle('active', turn === mePlayer);
        els.p2B.classList.toggle('active', turn === oppPlayer);
    }

    function updateTimerUI(t) {
        let m = Math.floor(t / 60);
        let s = t % 60;
        els.timer.textContent = `${m}:${s < 10 ? '0' + s : s}`;
    }

    function generateCode() {
        els.roomIn.value = Math.floor(1000 + Math.random() * 9000);
    }

    function updateUIState(online) {
        // reserved if you want more UI changes later
    }

    function closeOverlay() {
        document.getElementById('overlay').classList.remove('active');
        if (isHost && conn && conn.open) els.startBtn.disabled = false;
        els.board.innerHTML = '<div style="color:var(--subtext); text-align:center;"><p style="font-size:24px;">‚ö°</p><p>Ready for next round.</p></div>';
        gameActive = false;
    }

    // Help Popup Logic
    function openHelp() { document.getElementById('helpOverlay').classList.add('active'); }
    function closeHelp() { document.getElementById('helpOverlay').classList.remove('active'); }
    
    function resetGame() {
        sysMsg("Connection lost or closed.");
        els.status.textContent = "Disconnected";
        gameActive = false;
        isHost = false;

        if (timerInterval) clearInterval(timerInterval);

        document.getElementById('hostBtn').disabled = false;
        document.getElementById('joinBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;

        els.boardSize.disabled = true;
        els.gameMode.disabled = true;

        els.chatIn.disabled = true;
        document.getElementById('sendChatBtn').disabled = true;

        els.board.innerHTML = '<div style="color:var(--subtext); text-align:center;"><p style="font-size:24px;">‚ö°</p><p>Connect and play!</p></div>';

        scores = {1: 0, 2: 0};
        turn = 1;
        updateScoreUI();
    }

    // --- CHAT ---

    document.getElementById('sendChatBtn').onclick = sendChat;
    els.chatIn.onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };

    function sendChat() {
        let txt = els.chatIn.value.trim();
        if (!txt || !conn || !conn.open) return;
        addChat("Me", txt, 'me');
        conn.send({ type: 'chat', msg: txt });
        els.chatIn.value = '';
    }

    function addChat(sender, msg, type) {
        let div = document.createElement('div');
        div.className = `chat-msg ${type}`;
        if (type !== 'system') div.innerHTML = `<b>${sender}:</b> ${msg}`;
        else div.innerHTML = msg;
        els.chat.appendChild(div);
        els.chat.scrollTop = els.chat.scrollHeight;
    }

    function sysMsg(msg) { addChat("", msg, 'system'); }

    els.myNm.addEventListener('input', () => {
        if (conn && conn.open) conn.send({ type: 'name', name: els.myNm.value });
    });
</script>
</body>
</html>
